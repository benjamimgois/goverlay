name: Build Flatpak Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

jobs:
  build-flatpak:
    name: Build Flatpak Bundle
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Flatpak and flatpak-builder
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - name: Add Flathub repository
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install Flatpak SDK and runtime
        run: |
          sudo flatpak install -y flathub org.kde.Platform//6.7 org.kde.Sdk//6.7
          sudo flatpak install -y flathub io.qt.qtwebengine.BaseApp//6.7

      - name: Build Flatpak
        run: |
          flatpak-builder \
            --force-clean \
            --repo=flatpak-repo \
            --disable-rofiles-fuse \
            --ccache \
            --state-dir=.flatpak-builder \
            flatpak-build \
            io.github.benjamimgois.goverlay.yml

      - name: Create Flatpak bundle
        run: |
          flatpak build-bundle \
            flatpak-repo \
            goverlay-${{ github.ref_name }}.flatpak \
            io.github.benjamimgois.goverlay

      - name: Get bundle info
        id: bundle_info
        run: |
          BUNDLE_SIZE=$(du -h goverlay-${{ github.ref_name }}.flatpak | cut -f1)
          echo "size=$BUNDLE_SIZE" >> $GITHUB_OUTPUT
          echo "filename=goverlay-${{ github.ref_name }}.flatpak" >> $GITHUB_OUTPUT

      - name: Upload Flatpak bundle to release
        uses: softprops/action-gh-release@v1
        with:
          files: goverlay-${{ github.ref_name }}.flatpak
          body: |
            ## Flatpak Package

            **File:** `goverlay-${{ github.ref_name }}.flatpak`
            **Size:** ${{ steps.bundle_info.outputs.size }}

            ### Installation

            ```bash
            flatpak install goverlay-${{ github.ref_name }}.flatpak
            ```

            ### Running

            ```bash
            flatpak run io.github.benjamimgois.goverlay
            ```

            ### Requirements

            - Flatpak installed on your system
            - Flathub repository configured (for dependencies)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload bundle as artifact
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle
          path: goverlay-${{ github.ref_name }}.flatpak
          retention-days: 90
